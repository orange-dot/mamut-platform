# Codex Autofix for Failed CI
# Automatically attempts to fix failing tests/builds using OpenAI Codex
#
# This workflow:
# - Triggers when the main CI pipeline fails
# - Uses Codex to analyze and fix the failure
# - Creates a PR with the fix if successful
#
# Prerequisites:
# 1. OPENAI_API_KEY in repository secrets
# 2. Enable "Allow GitHub Actions to create PRs" in repo settings

name: Codex Autofix

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  autofix:
    name: Attempt Autofix
    runs-on: ubuntu-latest
    # Only run on failure and for non-main branches
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch != 'main' &&
      github.event.workflow_run.head_branch != 'master' &&
      vars.ENABLE_CODEX_AUTOFIX == 'true'

    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout failed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Restore dependencies
        run: |
          dotnet restore src/Orchestration.sln
          cd ui && npm ci

      - name: Get failure logs
        id: get-logs
        uses: actions/github-script@v7
        with:
          script: |
            // Get the failed workflow run's jobs
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            // Find failed jobs and get their logs
            const failedJobs = jobs.data.jobs.filter(j => j.conclusion === 'failure');
            let errorSummary = '';

            for (const job of failedJobs.slice(0, 3)) { // Limit to 3 jobs
              errorSummary += `\n## Failed Job: ${job.name}\n`;

              // Get job logs
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id,
                });
                // Extract last 100 lines of logs
                const logLines = logs.data.split('\n').slice(-100).join('\n');
                errorSummary += `\`\`\`\n${logLines}\n\`\`\`\n`;
              } catch (e) {
                errorSummary += `Could not fetch logs: ${e.message}\n`;
              }
            }

            core.setOutput('error-summary', errorSummary.substring(0, 10000)); // Limit size

      - name: Run Codex Autofix
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are debugging a CI failure in an Azure Durable Functions project.

            ## Failed Workflow Information
            - Branch: ${{ github.event.workflow_run.head_branch }}
            - Commit: ${{ github.event.workflow_run.head_sha }}
            - Workflow: ${{ github.event.workflow_run.name }}

            ## Error Logs
            ${{ steps.get-logs.outputs.error-summary }}

            ## Your Task
            1. Analyze the error logs to identify the root cause
            2. Find the minimal change needed to fix the issue
            3. Apply ONLY that change - do not refactor or improve unrelated code
            4. The fix must be correct and not break other tests

            ## Constraints
            - Only modify files that are directly related to the failure
            - Prefer the smallest possible fix
            - Do not change test assertions to make tests pass incorrectly
            - If the fix requires architectural changes, report it but don't attempt

            After making changes, run the relevant tests to verify the fix works.

      - name: Run tests to verify fix
        id: verify
        run: |
          echo "Running tests to verify fix..."
          dotnet test src/Orchestration.Tests/Orchestration.Tests.csproj \
            --filter "Category!=Integration" \
            --verbosity minimal \
            --no-restore || echo "verify-failed=true" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            git diff --stat
          fi

      - name: Create fix PR
        if: steps.check-changes.outputs.has-changes == 'true' && steps.verify.outputs.verify-failed != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            fix: Codex autofix for CI failure

            Automated fix for failed CI run on branch ${{ github.event.workflow_run.head_branch }}

            Original failure: ${{ github.event.workflow_run.html_url }}

            ü§ñ Generated with OpenAI Codex
          branch: codex-autofix/${{ github.event.workflow_run.head_branch }}
          base: ${{ github.event.workflow_run.head_branch }}
          title: "üîß Codex Autofix: CI failure on ${{ github.event.workflow_run.head_branch }}"
          body: |
            ## Automated Fix

            This PR was automatically generated by OpenAI Codex to fix a CI failure.

            ### Original Failure
            - **Branch**: `${{ github.event.workflow_run.head_branch }}`
            - **Workflow Run**: ${{ github.event.workflow_run.html_url }}
            - **Conclusion**: `${{ github.event.workflow_run.conclusion }}`

            ### Codex Analysis
            ${{ steps.codex.outputs.final-message }}

            ### Verification
            ‚úÖ Tests passed after applying this fix

            ---
            ‚ö†Ô∏è **Please review carefully** - automated fixes should be verified by a human before merging.

            <sub>ü§ñ Generated with [OpenAI Codex](https://openai.com/codex)</sub>
          labels: |
            autofix
            codex
          draft: true

      - name: Report unable to fix
        if: steps.check-changes.outputs.has-changes != 'true' || steps.verify.outputs.verify-failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const reason = '${{ steps.verify.outputs.verify-failed }}' === 'true'
              ? 'The attempted fix did not pass tests'
              : 'Codex could not determine a fix';

            // Find the PR for this branch
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${{ github.event.workflow_run.head_branch }}`,
              state: 'open',
            });

            if (prs.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs.data[0].number,
                body: `## ü§ñ Codex Autofix Attempted

            I tried to automatically fix the CI failure but was unable to.

            **Reason**: ${reason}

            **Failed Run**: ${{ github.event.workflow_run.html_url }}

            Please investigate manually.

            <sub>ü§ñ Generated with [OpenAI Codex](https://openai.com/codex)</sub>`,
              });
            }

            console.log(`Autofix failed: ${reason}`);
