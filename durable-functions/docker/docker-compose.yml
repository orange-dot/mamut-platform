# Docker Compose for Azure Durable Functions Demo Environment
# Purpose: Local development and demonstration (NOT for production use)
#
# Services:
# - azurite: Azure Storage emulator (Blob, Queue, Table)
# - servicebus-emulator: Azure Service Bus emulator
# - sql-edge: SQL Server for Service Bus emulator backend
# - cosmos-emulator: Azure Cosmos DB emulator (Linux preview)
# - functions: Azure Functions host (isolated worker)
#
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose logs -f        # View logs
#   docker-compose down           # Stop all services
#   docker-compose down -v        # Stop and remove volumes

services:
  # =============================================================================
  # Azurite - Azure Storage Emulator
  # Provides: Blob, Queue, Table storage (required for Durable Functions)
  # =============================================================================
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    container_name: azurite
    hostname: azurite
    restart: unless-stopped
    ports:
      - "10000:10000"  # Blob service
      - "10001:10001"  # Queue service
      - "10002:10002"  # Table service (required for Durable Functions)
    volumes:
      - azurite-data:/data
    command: "azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 --loose"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:10000', (r) => process.exit(r.statusCode === 400 ? 0 : 1)).on('error', () => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - orchestration-network

  # =============================================================================
  # SQL Edge - Backend for Service Bus Emulator
  # =============================================================================
  sql-edge:
    image: mcr.microsoft.com/azure-sql-edge:latest
    container_name: sql-edge
    hostname: sql-edge
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD:-SqlPassw0rd2025}
    ports:
      - "1433:1433"
    volumes:
      - sql-edge-data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P '${MSSQL_SA_PASSWORD:-SqlPassw0rd2025}' -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - orchestration-network

  # =============================================================================
  # Azure Service Bus Emulator
  # Provides: Queues, Topics, Subscriptions
  # =============================================================================
  servicebus-emulator:
    image: mcr.microsoft.com/azure-messaging/servicebus-emulator:latest
    container_name: servicebus-emulator
    hostname: servicebus-emulator
    restart: unless-stopped
    depends_on:
      sql-edge:
        condition: service_healthy
    environment:
      ACCEPT_EULA: "Y"
      SQL_SERVER: sql-edge
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD:-SqlPassw0rd2025}
    ports:
      - "5672:5672"   # AMQP
      - "5300:5300"   # Management
    volumes:
      - ./config/servicebus-config.json:/ServiceBus_Emulator/ConfigFiles/Config.json:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5300"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - orchestration-network

  # =============================================================================
  # Azure Event Hubs Emulator
  # Provides: Event streaming for Netherite storage provider
  # =============================================================================
  eventhubs-emulator:
    image: mcr.microsoft.com/azure-messaging/eventhubs-emulator:latest
    container_name: eventhubs-emulator
    hostname: eventhubs-emulator
    restart: unless-stopped
    depends_on:
      azurite:
        condition: service_healthy
    environment:
      BLOB_SERVER: azurite
      METADATA_SERVER: azurite
      ACCEPT_EULA: "Y"
    ports:
      - "5673:5672"   # AMQP (5673 to avoid conflict with Service Bus)
      - "9092:9092"   # Kafka
    volumes:
      - ./config/eventhubs-config.json:/Eventhubs_Emulator/ConfigFiles/Config.json:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5672"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - orchestration-network

  # =============================================================================
  # Azure Cosmos DB Emulator (Linux vNext Preview)
  # Provides: NoSQL API (Gateway mode)
  # Note: This is the new lightweight Linux emulator, not the full Windows emulator
  # =============================================================================
  cosmos-emulator:
    image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:vnext-preview
    container_name: cosmos-emulator
    hostname: cosmos-emulator
    restart: unless-stopped
    ports:
      - "8081:8081"   # Gateway endpoint
      - "9234:1234"   # Data Explorer (mapped to 9234 to avoid Windows reserved ports)
    environment:
      - PROTOCOL=https
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:8081/_explorer/emulator.pem"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - orchestration-network

  # =============================================================================
  # Azure Functions Host (Isolated Worker - .NET 9)
  # Builds and runs the Orchestration.Functions project
  # =============================================================================
  functions:
    build:
      context: ..
      dockerfile: docker/Dockerfile.functions
    container_name: orchestration-functions
    hostname: orchestration-functions
    restart: unless-stopped
    depends_on:
      azurite:
        condition: service_healthy
      servicebus-emulator:
        condition: service_started
      cosmos-emulator:
        condition: service_started
    ports:
      - "7071:80"     # HTTP trigger endpoint
    volumes:
      - ./config/host.json:/home/site/wwwroot/host.json:ro
    environment:
      # Azure Storage (Azurite) - Required for Functions runtime and Netherite
      - AzureWebJobsStorage=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;
      # Netherite SingleHost mode - bypasses Event Hubs for local development
      - EventHubsConnection=SingleHost
      # MSSQL for Application data (workflow records, idempotency)
      - SqlConnectionString=Server=sql-edge;Database=OrchestrationDb;User Id=sa;Password=${MSSQL_SA_PASSWORD:-SqlPassw0rd2025};TrustServerCertificate=True;Encrypt=False;
      # Workflow definitions storage
      - WorkflowStorageConnection=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;
      - WorkflowStorageContainer=workflow-definitions
      # Service Bus Emulator
      - ServiceBusConnection=Endpoint=sb://servicebus-emulator;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY_VALUE;UseDevelopmentEmulator=true;
      # Cosmos DB Emulator
      - CosmosDbConnection=AccountEndpoint=https://cosmos-emulator:8081/;AccountKey=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==;
      # Functions runtime
      - FUNCTIONS_WORKER_RUNTIME=dotnet-isolated
      - ASPNETCORE_URLS=http://+:80
      # Required for Durable Functions webhooks
      - WEBSITE_HOSTNAME=localhost:80
    networks:
      - orchestration-network

  # =============================================================================
  # UI - React Frontend
  # Serves the orchestration dashboard and proxies API requests to functions
  # =============================================================================
  ui:
    build:
      context: ../ui
      dockerfile: Dockerfile
    container_name: orchestration-ui
    hostname: orchestration-ui
    restart: unless-stopped
    depends_on:
      - functions
    ports:
      - "3000:80"
    networks:
      - orchestration-network

  # =============================================================================
  # IoT Device Simulator
  # Generates realistic IoT events for workflow testing and demonstration
  # Uses direct AMQP connection to Service Bus emulator (bypasses SDK localhost restriction)
  # =============================================================================
  iot-simulator:
    build:
      context: ../simulator
      dockerfile: Dockerfile
    container_name: iot-simulator
    hostname: iot-simulator
    restart: unless-stopped
    depends_on:
      servicebus-emulator:
        condition: service_started  # Use service_started as emulator takes time to become healthy
    ports:
      - "8085:8080"   # Simulator REST API
    environment:
      # Service Bus emulator - direct AMQP connection (bypasses Azure SDK localhost restriction)
      - SIMULATOR_SERVICEBUS_USEEMULATOR=true
      - SIMULATOR_SERVICEBUS_EMULATORHOST=servicebus-emulator:5672
      - SIMULATOR_SERVICEBUS_QUEUENAME=device-events
      - SIMULATOR_SERVICEBUS_USEMOCK=false
      # Simulator settings
      - SIMULATOR_MODE=random
      - SIMULATOR_INTERVAL_MS=5000
      - SIMULATOR_AUTOSTART=true
      - SIMULATOR_LOGGING_LEVEL=info
      - SIMULATOR_LOGGING_FORMAT=console
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - orchestration-network

# =============================================================================
# Networks
# =============================================================================
networks:
  orchestration-network:
    driver: bridge
    name: orchestration-network

# =============================================================================
# Volumes (persistent storage)
# =============================================================================
volumes:
  azurite-data:
    name: orchestration-azurite-data
  sql-edge-data:
    name: orchestration-sql-edge-data
